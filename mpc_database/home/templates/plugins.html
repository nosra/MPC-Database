{% extends 'base.html' %}
{% load static %}
{% block title %}Plugins{% endblock %}

{% block content %}
<!-- getting rid of borders for now -->
<div class="window flex min-h-dvh w-full border-[#004F99]">
    <div class="plugin w-70 shrink-0">
        <div class="plugin__categories flex flex-col sticky top-0 text-left w-full border-[#004F99] pl-10 pr-10 pt-5 gap-y-3">
            <div class="flex flex-row w-full justify-center items-center">
                <label class="category__title font-bold text-center">
                    Categories
                </label>
            </div>
            <!-- pro/alt pills -->
            <div class="flex gap-2 justify-center pb-5">
                <a
                    href="{% url 'plugins' %}?tab=pro{% if active_category %}&category={{ active_category }}{% endif %}{% if search_query %}&q={{ search_query|urlencode }}{% endif %}"
                    class="px-3 py-1 rounded-full text-sm font-semibold transition-colors duration-200
                        {% if active_tab == 'pro' %}
                            bg-[#004F99] text-white
                        {% else %}
                            bg-[#1A356B] text-white hover:bg-[#005FCC]
                        {% endif %}"
                >
                    PRO
                </a>

                <a
                    href="{% url 'plugins' %}?tab=alt{% if active_category %}&category={{ active_category }}{% endif %}{% if search_query %}&q={{ search_query|urlencode }}{% endif %}"
                    class="px-3 py-1 rounded-full text-sm font-semibold transition-colors duration-200
                        {% if active_tab == 'alt' %}
                            bg-[#004F99] text-white
                        {% else %}
                            bg-[#1A356B] text-white hover:bg-[#005FCC]
                        {% endif %}"
                >
                    ALT
                </a>
            </div>

            <!-- category pills (OUTDATED, do not uncomment)
            <a href="{% url 'plugins' %}?tab={{ active_tab }}&category=EFX"
            class="category__pill flex flex-row gap-2 items-center rounded-4xl pl-5 pr-15 pt-2 pb-2 p-2 transition-colors duration-200 cursor-pointer
                    {% if active_category == 'EFX' %} bg-[#004F99] text-white {% else %} hover:bg-[#004F99] {% endif %}">
                <img class="size-7" src="{% static 'plugins/effects.svg' %}"/>
                <span class="category">
                    Effects
                </span>
            </a>

            <a href="{% url 'plugins' %}?tab={{ active_tab }}&category=SYN"
            class="category__pill flex flex-row gap-2 items-center rounded-4xl pl-5 pr-15 pt-2 pb-2 transition-colors duration-200 cursor-pointer
                    {% if active_category == 'SYN' %} bg-[#004F99] text-white {% else %} hover:bg-[#004F99] {% endif %}">
                <img class="size-7" src="{% static 'plugins/synth.svg' %}"/>
                <span class="category">
                    Synths
                </span>
            </a>

            <a href="{% url 'plugins' %}?tab={{ active_tab }}&category=CMP"
            class="category__pill flex flex-row gap-2 items-center rounded-4xl pl-5 pr-15 pt-2 pb-2 transition-colors duration-200 cursor-pointer
                    {% if active_category == 'CMP' %} bg-[#004F99] text-white {% else %} hover:bg-[#004F99] {% endif %}">
                <img class="size-7" src="{% static 'plugins/compress.svg' %}"/>
                <span class="category">
                    Compressors
                </span>
            </a>

            <a href="{% url 'plugins' %}?tab={{ active_tab }}&category=DST"
            class="category__pill flex flex-row gap-2 items-center rounded-4xl pl-5 pr-15 pt-2 pb-2 transition-colors duration-200 cursor-pointer
                    {% if active_category == 'DST' %} bg-[#004F99] text-white {% else %} hover:bg-[#004F99] {% endif %}">
                <img class="size-7" src="{% static 'plugins/distort.svg' %}"/>
                <span class="category">
                    Distorters
                </span>
            </a>

            <a href="{% url 'plugins' %}?tab={{ active_tab }}&category=DAW"
            class="category__pill flex flex-row gap-2 items-center rounded-4xl pl-5 pr-15 pt-2 pb-2 transition-colors duration-200 cursor-pointer
                    {% if active_category == 'DAW' %} bg-[#004F99] text-white {% else %} hover:bg-[#004F99] {% endif %}">
                <img class="size-7" src="{% static 'plugins/mixer.svg' %}"/>
                <span class="category">
                    DAW
                </span>
            </a>
            -->
            <div class="flex flex-col gap-1 mt-4">
                {% for category in categories %}
                <details class="group" {% if category.slug == active_parent_slug %}open{% endif %}>
                    <summary class="list-none flex items-center justify-between px-4 py-2 cursor-pointer rounded-xl transition-all duration-200
                                    {% if category.slug == active_parent_slug %}
                                        /* active Parent: white text, slight background tint */
                                        text-white bg-white/10 font-bold
                                    {% else %}
                                        /* inactive: grey text, hover brightens */
                                        text-slate-400 hover:text-white hover:bg-white/5
                                    {% endif %}">
                        
                        <a href="{% url 'plugins' %}?tab={{ active_tab }}&category={{ category.slug }}{% if search_query %}&q={{ search_query|urlencode }}{% endif %}"
                        class="flex items-center gap-3 grow h-full">
                        
                        {% if category.icon %}
                                <img class="size-5 transition-opacity duration-200 {% if category.slug == active_parent_slug %}opacity-100{% else %}opacity-70 group-hover:opacity-100{% endif %}" 
                                    src="{{ category.icon.url }}"/>
                            {% endif %}
                            
                            <span>{{ category.name }}</span>
                        </a>

                        <div class="ml-2 flex h-5 w-5 items-center justify-center transform transition-transform duration-200 group-open:rotate-180 origin-center">
                            <svg class="w-3 h-3 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                    </summary>

                    <div class="flex flex-col pt-1 pb-2">
                        {% for sub in category.subcategories.all %}
                            <a href="{% url 'plugins' %}?tab={{ active_tab }}&category={{ sub.slug }}{% if search_query %}&q={{ search_query|urlencode }}{% endif %}"
                            class="group flex items-center w-full pl-12 pr-4 py-2 text-sm rounded-lg transition-all duration-200 cursor-pointer border 
                                    {% if active_category == sub.slug %} 
                                        /* active: visible Blue Border */
                                        bg-blue-600/20 text-blue-400 font-semibold border-blue-500
                                    {% else %} 
                                        /* inactive: transparent border (reserves space) */
                                        text-slate-400 border-transparent hover:text-white hover:bg-white/10
                                    {% endif %}">
                                
                                <span class="w-1.5 h-1.5 rounded-full mr-3 transition-colors duration-200
                                            {% if active_category == sub.slug %} bg-blue-400 shadow-[0_0_8px_rgba(96,165,250,0.6)] {% else %} bg-slate-600 group-hover:bg-slate-400 {% endif %}">
                                </span>
                                {{ sub.name }}
                            </a>
                        {% endfor %}
                    </div>
                </details>
                {% endfor %}
            </div>
        </div>
    </div>
    <div class="plugin__view grow bg-white rounded-3xl mr-12">
        <!-- search bar -->
        <div class="plugin__navbar flex flex-col items-center justify-center pt-4 pb-4 px-10">
            <form
                id="plugin-search-form"
                method="get"
                action="{% url 'plugins' %}"
                class="w-full max-w-2xl relative flex gap-3" 
            >
                {# keep current tab & category on non-AJAX submit #}
                <input type="hidden" name="tab" value="{{ active_tab }}">
                {% if active_category %}
                    <input type="hidden" name="category" value="{{ active_category }}">
                {% endif %}

                <div class="relative grow">
                    <input
                        id="plugin-search"
                        type="text"
                        name="q"
                        value="{{ search_query|default:'' }}"
                        placeholder="Search plugins..."
                        class="w-full rounded-2xl bg-gray-100 pl-12 pr-4 py-2
                            text-gray-800 placeholder-gray-400
                            shadow-sm border border-gray-200
                            focus:outline-none focus:ring-2 focus:ring-[#004F99] focus:border-transparent
                            transition duration-200"
                    />
                    <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500"
                        fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 1010.5 18a7.5 7.5 0 006.15-3.35z"/>
                    </svg>
                </div>

                <div class="relative min-w-[140px]">
                    <select 
                        name="sort" 
                        id="plugin-sort"
                        class="w-full appearance-none rounded-2xl bg-gray-100 pl-4 pr-10 py-2
                            text-gray-800 font-medium cursor-pointer
                            shadow-sm border border-gray-200
                            focus:outline-none focus:ring-2 focus:ring-[#004F99] focus:border-transparent
                            transition duration-200"
                    >
                        <option value="newest" {% if current_sort == 'newest' %}selected{% endif %}>Newest</option>
                        <option value="rating" {% if current_sort == 'rating' %}selected{% endif %}>Top Rated</option>
                        <option value="name" {% if current_sort == 'name' %}selected{% endif %}>Name (A-Z)</option>
                        <option value="oldest" {% if current_sort == 'oldest' %}selected{% endif %}>Oldest</option>
                    </select>
                    <svg class="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500 pointer-events-none" 
                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
            </form>
        </div>
        <div class="plugin__plugins flex flex-wrap content-start p-4 overflow-y-auto" id="plugin-list">
            {% include "partials/plugin_cards.html" %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('plugin-search');
    const sortSelect  = document.getElementById('plugin-sort'); // New Reference
    const pluginList  = document.getElementById('plugin-list');
    const searchForm  = document.getElementById('plugin-search-form');

    if (!searchInput || !pluginList) return;

    let debounceTimeout = null;

    function fetchPlugins(query) {
        // build URL with current query params
        const url = new URL(window.location.href);

        // Handle Search
        if (query) {
            url.searchParams.set('q', query);
        } else {
            url.searchParams.delete('q');
        }

        // handle sort / select
        if (sortSelect && sortSelect.value) {
            url.searchParams.set('sort', sortSelect.value);
        }

        // fetch
        fetch(url.toString(), {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            pluginList.innerHTML = html;
            window.history.replaceState({}, '', url);
        })
        .catch(err => {
            console.error('Error fetching plugins:', err);
        });
    }

    // search listener 
    searchInput.addEventListener('input', function (e) {
        const query = e.target.value;
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(() => {
            fetchPlugins(query);
        }, 250);
    });

    // sort listener 
    if (sortSelect) {
        sortSelect.addEventListener('change', function() {
            // no debounce for dropdown
            fetchPlugins(searchInput.value);
        });
    }

    // form submit listener
    if (searchForm) {
        searchForm.addEventListener('submit', function (e) {
            e.preventDefault();
            fetchPlugins(searchInput.value);
        });
    }
});

// keeping correct category expanded if a subcategory is expanded
document.addEventListener("DOMContentLoaded", function() {
    // check if we have an active category slug in the URL or template context
    const activeSlug = "{{ active_category }}"; 
    
    if (activeSlug) {
        // try to find a subcategory link with this slug
        const activeLink = document.querySelector(`.subcategory-link[data-slug="${activeSlug}"]`);
        
        if (activeLink) {
            // if found, find its parent <details> tag and open it
            const parentDetails = activeLink.closest('details');
            if (parentDetails) {
                parentDetails.open = true;
            }
        } else {
            // if not found, it might be a main Category. 
            // try to find the details with ID cat-slug
            const mainDetails = document.getElementById(`cat-${activeSlug}`);
            if (mainDetails) {
                mainDetails.open = true;
            }
        }
    }
});
</script>


{% endblock %}