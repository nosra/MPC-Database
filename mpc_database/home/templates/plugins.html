{% extends 'base.html' %}
{% load static %}
{% block title %}Plugins{% endblock %}

{% block content %}
<!-- getting rid of borders for now -->
<div class="window flex min-h-dvh w-full border-[#004F99] overflow-hidden">
    <div class="plugin overflow-auto">
        <div class="plugin__categories flex flex-col text-left w-full h-full border-[#004F99] pl-10 pr-10 pt-5 gap-3">
            <label class="category__title font-bold text-center">
                Categories
            </label>

            <!-- pro/alt pills  -->
            <div class="flex gap-2 justify-center">
                <a
                    href="{% url 'plugins' %}?tab=pro{% if active_category %}&category={{ active_category }}{% endif %}{% if search_query %}&q={{ search_query|urlencode }}{% endif %}"
                    class="px-3 py-1 rounded-full text-sm font-semibold transition-colors duration-200
                        {% if active_tab == 'pro' %}
                            bg-[#004F99] text-white
                        {% else %}
                            bg-[#1A356B] text-white hover:bg-[#005FCC]
                        {% endif %}"
                >
                    PRO
                </a>

                <a
                    href="{% url 'plugins' %}?tab=alt{% if active_category %}&category={{ active_category }}{% endif %}{% if search_query %}&q={{ search_query|urlencode }}{% endif %}"
                    class="px-3 py-1 rounded-full text-sm font-semibold transition-colors duration-200
                        {% if active_tab == 'alt' %}
                            bg-[#004F99] text-white
                        {% else %}
                            bg-[#1A356B] text-white hover:bg-[#005FCC]
                        {% endif %}"
                >
                    ALT
                </a>
            </div>

            <!-- category pills -->
            <a href="{% url 'plugins' %}?tab={{ active_tab }}&category=EFX"
            class="category__pill flex flex-row gap-2 items-center rounded-4xl p-2 transition-colors duration-200 cursor-pointer
                    {% if active_category == 'EFX' %} bg-[#004F99] text-white {% else %} hover:bg-[#004F99] {% endif %}">
                <img class="size-7" src="{% static 'plugins/effects.svg' %}"/>
                <span class="category">
                    Effects
                </span>
            </a>

            <a href="{% url 'plugins' %}?tab={{ active_tab }}&category=SYN"
            class="category__pill flex flex-row gap-2 items-center rounded-4xl p-2 transition-colors duration-200 cursor-pointer
                    {% if active_category == 'SYN' %} bg-[#004F99] text-white {% else %} hover:bg-[#004F99] {% endif %}">
                <img class="size-7" src="{% static 'plugins/synth.svg' %}"/>
                <span class="category">
                    Synths
                </span>
            </a>

            <a href="{% url 'plugins' %}?tab={{ active_tab }}&category=CMP"
            class="category__pill flex flex-row gap-2 items-center rounded-4xl p-2 transition-colors duration-200 cursor-pointer
                    {% if active_category == 'CMP' %} bg-[#004F99] text-white {% else %} hover:bg-[#004F99] {% endif %}">
                <img class="size-7" src="{% static 'plugins/compress.svg' %}"/>
                <span class="category">
                    Compressors
                </span>
            </a>

            <a href="{% url 'plugins' %}?tab={{ active_tab }}&category=DST"
            class="category__pill flex flex-row gap-2 items-center rounded-4xl p-2 transition-colors duration-200 cursor-pointer
                    {% if active_category == 'DST' %} bg-[#004F99] text-white {% else %} hover:bg-[#004F99] {% endif %}">
                <img class="size-7" src="{% static 'plugins/distort.svg' %}"/>
                <span class="category">
                    Distorters
                </span>
            </a>

            <a href="{% url 'plugins' %}?tab={{ active_tab }}&category=DAW"
            class="category__pill flex flex-row gap-2 items-center rounded-4xl p-2 transition-colors duration-200 cursor-pointer
                    {% if active_category == 'DAW' %} bg-[#004F99] text-white {% else %} hover:bg-[#004F99] {% endif %}">
                <img class="size-7" src="{% static 'plugins/mixer.svg' %}"/>
                <span class="category">
                    DAW
                </span>
            </a>
        </div>
    </div>
    <div class="plugin__view grow bg-white rounded-3xl mr-12">
        <!-- search bar -->
        <div class="plugin__navbar flex flex-col items-center justify-center pt-4 pb-4 px-10">
            <!-- search form (works with JS and as a normal GET fallback) -->
            <form
                id="plugin-search-form"
                method="get"
                action="{% url 'plugins' %}"
                class="w-full max-w-md relative"
            >
                {# keep current tab & category on non-AJAX submit #}
                <input type="hidden" name="tab" value="{{ active_tab }}">
                {% if active_category %}
                    <input type="hidden" name="category" value="{{ active_category }}">
                {% endif %}

                <input
                    id="plugin-search"
                    type="text"
                    name="q"
                    value="{{ search_query|default:'' }}"
                    placeholder="Search plugins..."
                    class="w-full rounded-2xl bg-gray-100 pl-12 pr-4 py-2
                        text-gray-800 placeholder-gray-400
                        shadow-sm border border-gray-200
                        focus:outline-none focus:ring-2 focus:ring-[#004F99] focus:border-transparent
                        transition duration-200"
                />

                <!-- icon -->
                <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500"
                    fill="none" stroke="currentColor" stroke-width="2"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 1010.5 18a7.5 7.5 0 006.15-3.35z"/>
                </svg>
            </form>
        </div>
        <!-- this will be where the plugins are -->
        <div class="plugin__plugins flex flex-wrap" id="plugin-list">
            {% include "partials/plugin_cards.html" %}
        </div>
    </div>
</div>

<script>
// ajax querying
document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('plugin-search');
    const pluginList  = document.getElementById('plugin-list');
    const searchForm  = document.getElementById('plugin-search-form');

    if (!searchInput || !pluginList) return;

    let debounceTimeout = null;

    function fetchPlugins(query) {
        // build URL with current query params
        const url = new URL(window.location.href);

        if (query) {
            url.searchParams.set('q', query);
        } else {
            url.searchParams.delete('q');
        }

        // fetch to get HTML
        // this is partial
        fetch(url.toString(), {
            headers: {
                'X-Requested-With': 'XMLHttpRequest' // so view knows it's AJAX
            }
        })
        .then(response => response.text())
        .then(html => {
            // replace the plugin cards container with new HTML
            pluginList.innerHTML = html;

            // update URL in address bar without reloading
            window.history.replaceState({}, '', url);
        })
        .catch(err => {
            console.error('Error fetching plugins:', err);
        });
    }

    // live search with debounce
    searchInput.addEventListener('input', function (e) {
        const query = e.target.value;
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(() => {
            fetchPlugins(query);
        }, 250); // delay is adjustable
    });

    // prevent full form submit; use AJAX instead
    if (searchForm) {
        searchForm.addEventListener('submit', function (e) {
            e.preventDefault();
            fetchPlugins(searchInput.value);
        });
    }
});
</script>


{% endblock %}